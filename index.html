<!DOCTYPE html>
<html class="light" lang="ko">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AI êµ¬ë… ê´€ë¦¬ì</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#6464f2",
                        "background-light": "#F9FAFB",
                        "background-dark": "#101022",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "1rem",
                        "xl": "1.5rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            min-height: max(884px, 100dvh);
        }
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast {
            animation: slideIn 0.3s ease-out forwards;
        }
        .toast.hiding {
            animation: fadeOut 0.3s ease-out forwards;
        }
        /* Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 font-display min-h-screen flex flex-col items-center">

<!-- Main Container -->
<div class="w-full max-w-md md:max-w-lg lg:max-w-2xl bg-background-light dark:bg-background-dark min-h-screen relative shadow-2xl overflow-hidden pb-20">

    <!-- Header Section -->
    <header class="bg-gradient-to-br from-primary to-purple-600 pt-10 pb-8 px-6 rounded-b-[2rem] shadow-lg relative overflow-hidden mb-6">
        <div class="absolute top-[-20%] right-[-10%] w-48 h-48 bg-white/10 rounded-full blur-2xl pointer-events-none"></div>
        <div class="relative z-10">
            <div class="flex items-center gap-2 mb-2">
                <span class="material-symbols-outlined text-white text-3xl">smart_toy</span>
                <h1 class="text-white tracking-tight text-2xl font-bold">AI êµ¬ë… ê´€ë¦¬ì</h1>
            </div>
            <p class="text-white/90 text-sm font-medium leading-relaxed">ë‚´ AI ì„œë¹„ìŠ¤ë¥¼ í•œëˆˆì—,<br/>ìŠ¤ë§ˆíŠ¸í•˜ê²Œ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>
    </header>

    <main class="px-4 -mt-6 pb-20 space-y-5">
        
        <!-- Stats Summary Cards -->
        <section class="flex gap-3 overflow-x-auto no-scrollbar pb-2 snap-x">
            <!-- Card 1: Count -->
            <div class="snap-start flex-none w-[140px] bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 flex flex-col justify-between h-32">
                <div class="flex justify-between items-start">
                    <div class="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg">
                        <span class="material-symbols-outlined text-primary text-xl">subscriptions</span>
                    </div>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">êµ¬ë… ì¤‘</p>
                    <p id="totalCount" class="text-xl font-bold text-slate-900 dark:text-white">0 ê°œ</p>
                </div>
            </div>
            <!-- Card 2: Monthly -->
            <div class="snap-start flex-none w-[160px] bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 flex flex-col justify-between h-32">
                <div class="flex justify-between items-start">
                    <div class="p-2 bg-emerald-50 dark:bg-emerald-900/30 rounded-lg">
                        <span class="material-symbols-outlined text-emerald-500 text-xl">payments</span>
                    </div>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">ì´ë²ˆ ë‹¬ ì˜ˆìƒ ì§€ì¶œ</p>
                    <p id="totalMonthly" class="text-xl font-bold text-slate-900 dark:text-white">â‚©0</p>
                </div>
            </div>
            <!-- Card 3: Yearly -->
            <div class="snap-start flex-none w-[160px] bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 flex flex-col justify-between h-32">
                <div class="flex justify-between items-start">
                    <div class="p-2 bg-amber-50 dark:bg-amber-900/30 rounded-lg">
                        <span class="material-symbols-outlined text-amber-500 text-xl">trending_up</span>
                    </div>
                </div>
                <div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 font-medium">ì—°ê°„ ì˜ˆìƒ ë¹„ìš©</p>
                    <p id="totalYearly" class="text-xl font-bold text-slate-900 dark:text-white">â‚©0</p>
                </div>
            </div>
        </section>

        <!-- API Key Accordion -->
        <section>
            <details id="apiKeyAccordion" class="group bg-white dark:bg-gray-800 rounded-xl shadow-md border border-gray-100 dark:border-gray-700 overflow-hidden transition-all duration-300">
                <summary class="flex cursor-pointer items-center justify-between gap-4 p-4 list-none bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-750 transition-colors">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-gray-400 group-open:text-primary">settings</span>
                        <span class="text-sm font-semibold text-slate-800 dark:text-white">AI ë¶„ì„ ì„¤ì • (ì„ íƒì‚¬í•­)</span>
                    </div>
                    <span class="material-symbols-outlined text-gray-400 transition-transform duration-300 group-open:rotate-180">expand_more</span>
                </summary>
                <div class="px-4 pb-5 pt-2 border-t border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-800/50">
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-medium text-gray-500">Google AI Studio API Key</label>
                            <a class="text-xs text-primary hover:underline flex items-center gap-1" href="https://aistudio.google.com/app/apikey" target="_blank">
                                Get Key <span class="material-symbols-outlined text-[12px]">open_in_new</span>
                            </a>
                        </div>
                        <div class="relative">
                            <input id="inputApiKey" class="w-full h-11 pl-4 pr-12 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all outline-none" placeholder="Gemini API Key ì…ë ¥" type="password"/>
                            <button id="toggleApiKey" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <span class="material-symbols-outlined text-lg">visibility</span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between mt-1">
                            <p class="text-[11px] text-amber-600 dark:text-amber-500 flex items-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">warning</span>
                                KeyëŠ” ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.
                            </p>
                            <button id="btnSaveApiKey" class="h-9 px-4 bg-primary hover:bg-indigo-600 text-white text-xs font-bold rounded-lg transition-colors shadow-sm">
                                ì €ì¥
                            </button>
                        </div>
                    </div>
                </div>
            </details>
        </section>

        <!-- Add Subscription Form -->
        <section class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-5 border border-gray-100 dark:border-gray-700">
            <h2 class="text-sm font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
                <span id="formTitleIcon" class="material-symbols-outlined text-primary">add_circle</span> 
                <span id="formTitleText">ìƒˆ êµ¬ë… ì¶”ê°€</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Service Name -->
                <div class="col-span-1 md:col-span-2">
                    <label class="block text-xs font-medium text-gray-500 mb-1">ì„œë¹„ìŠ¤ ì´ë¦„ <span class="text-red-500">*</span></label>
                    <input id="inputName" class="w-full h-11 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary outline-none transition-colors" placeholder="ì˜ˆ: ChatGPT Plus" type="text"/>
                    <p id="errorName" class="text-red-500 text-xs mt-1 hidden">ì„œë¹„ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                </div>
                <!-- Category -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ì¹´í…Œê³ ë¦¬ <span class="text-red-500">*</span></label>
                    <select id="inputCategory" class="w-full h-11 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary outline-none transition-colors">
                        <option value="">ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="GPT">GPT</option>
                        <option value="Claude">Claude</option>
                        <option value="Gemini">Gemini</option>
                        <option value="ê¸°íƒ€ AI">ê¸°íƒ€ AI</option>
                        <option value="ìƒì‚°ì„±">ìƒì‚°ì„±</option>
                        <option value="ë””ìì¸">ë””ìì¸</option>
                        <option value="ê°œë°œ">ê°œë°œ</option>
                    </select>
                    <p id="errorCategory" class="text-red-500 text-xs mt-1 hidden">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                </div>
                <!-- Cost -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ì›” ê²°ì œ ê¸ˆì•¡ <span class="text-red-500">*</span></label>
                    <div class="flex gap-2">
                        <select id="inputCurrency" class="w-24 h-11 px-2 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary outline-none transition-colors">
                            <option value="KRW">KRW (â‚©)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                        <input id="inputCost" class="flex-1 h-11 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary outline-none transition-colors" placeholder="22000" type="number" min="0"/>
                    </div>
                    <p id="errorCost" class="text-red-500 text-xs mt-1 hidden">ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                </div>
                <!-- Date -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ë‹¤ìŒ ê²°ì œì¼ <span class="text-red-500">*</span></label>
                    <input id="inputDate" class="w-full h-11 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary text-gray-600 dark:text-gray-300 outline-none transition-colors" type="date"/>
                    <p id="errorDate" class="text-red-500 text-xs mt-1 hidden">ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                </div>
                <!-- Memo -->
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ë©”ëª¨ (ì„ íƒ)</label>
                    <input id="inputMemo" class="w-full h-11 px-4 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary outline-none" placeholder="ì‚¬ìš© ëª©ì ì´ë‚˜ íŠ¹ì´ì‚¬í•­" type="text"/>
                </div>
            </div>
            
            <div class="flex gap-2 mt-5">
                <button id="btnCancelEdit" class="hidden flex-1 h-12 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-xl transition-all flex items-center justify-center gap-2">
                    ì·¨ì†Œ
                </button>
                <button id="btnAdd" class="flex-1 h-12 bg-primary hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg shadow-indigo-200 dark:shadow-none transition-all flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined">check</span>
                    <span id="btnAddText">êµ¬ë… ì¶”ê°€í•˜ê¸°</span>
                </button>
            </div>
        </section>

        <!-- Category Filter Tabs -->
        <section class="flex gap-2 overflow-x-auto no-scrollbar py-1" id="categoryTabs">
            <!-- Tabs will be injected via JS -->
        </section>

        <!-- Subscription List -->
        <section id="subList" class="grid gap-4">
            <!-- List Items will be injected here -->
        </section>

        <!-- AI Analysis Section -->
        <section class="bg-gradient-to-br from-indigo-50 to-white dark:from-gray-800 dark:to-gray-900 rounded-xl p-5 shadow-lg border border-indigo-100 dark:border-gray-700 mb-10">
            <div class="flex items-center gap-2 mb-3">
                <div class="p-1.5 bg-primary rounded-lg">
                    <span class="material-symbols-outlined text-white text-lg">auto_awesome</span>
                </div>
                <h2 class="text-sm font-bold text-slate-800 dark:text-white">AI ë§ì¶¤ ë¶„ì„</h2>
            </div>

            <!-- State: No API Key -->
            <div id="aiNoKey" class="bg-white/60 dark:bg-black/20 rounded-lg p-4 border border-indigo-50 dark:border-gray-700 text-center py-8">
                <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
                    API Keyë¥¼ ì„¤ì •í•˜ë©´ ê°œì¸ ë§ì¶¤ AI ì„œë¹„ìŠ¤ ì¶”ì²œê³¼<br/>êµ¬ë… ì •ë¦¬ ì¡°ì–¸ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
                <button id="btnGoToSettings" class="text-xs px-4 py-2 bg-primary text-white rounded-full hover:bg-indigo-600 transition-colors font-medium">
                    ìœ„ë¡œ ê°€ì„œ API Key ì„¤ì •í•˜ê¸°
                </button>
            </div>

            <!-- State: Has API Key -->
            <div id="aiWithKey" class="hidden space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-500 mb-1">ê´€ì‹¬ ë¶„ì•¼ ë˜ëŠ” ì§ì—…</label>
                    <div class="flex gap-2">
                        <input id="inputInterest" class="flex-1 h-10 px-4 rounded-lg bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 text-sm focus:ring-primary focus:border-primary outline-none" placeholder="ì˜ˆ: í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì, ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°" type="text"/>
                        <button id="btnAnalyze" class="h-10 px-4 bg-primary hover:bg-indigo-600 text-white text-xs font-bold rounded-lg transition-colors shadow-sm flex items-center gap-2 whitespace-nowrap disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="material-symbols-outlined text-[16px]">sparkle</span>
                            AI ì¶”ì²œ ë°›ê¸°
                        </button>
                    </div>
                </div>

                <!-- Analysis Result -->
                <div id="aiResult" class="hidden bg-white/80 dark:bg-black/30 rounded-lg p-4 border border-indigo-100 dark:border-gray-700 text-sm text-slate-700 dark:text-gray-300 leading-relaxed whitespace-pre-wrap"></div>
            </div>
        </section>
    </main>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 w-max max-w-[90vw]"></div>

</div>

<!-- JavaScript Logic -->
<script>
    // --- State Management ---
    const STORAGE_KEY_SUBS = 'aiSubscriptions';
    const STORAGE_KEY_API = 'geminiApiKey';
    
    let subscriptions = [];
    let apiKey = '';
    let editingId = null;
    let currentCategory = 'All';

    // --- Config ---
    const CATEGORIES = ['All', 'GPT', 'Claude', 'Gemini', 'ê¸°íƒ€ AI', 'ìƒì‚°ì„±', 'ë””ìì¸', 'ê°œë°œ'];
    const EXCHANGE_RATE = 1400; // Fixed rate: 1 USD = 1400 KRW (Approx)
    
    const CATEGORY_COLORS = {
        'GPT': 'bg-green-100 text-green-800 dark:bg-green-900/40 dark:text-green-300',
        'Claude': 'bg-orange-100 text-orange-800 dark:bg-orange-900/40 dark:text-orange-300',
        'Gemini': 'bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300',
        'ê¸°íƒ€ AI': 'bg-purple-100 text-purple-800 dark:bg-purple-900/40 dark:text-purple-300',
        'ìƒì‚°ì„±': 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300',
        'ë””ìì¸': 'bg-pink-100 text-pink-800 dark:bg-pink-900/40 dark:text-pink-300',
        'ê°œë°œ': 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-300'
    };

    // --- DOM Elements ---
    const els = {
        totalCount: document.getElementById('totalCount'),
        totalMonthly: document.getElementById('totalMonthly'),
        totalYearly: document.getElementById('totalYearly'),
        apiKeyAccordion: document.getElementById('apiKeyAccordion'),
        inputApiKey: document.getElementById('inputApiKey'),
        toggleApiKey: document.getElementById('toggleApiKey'),
        btnSaveApiKey: document.getElementById('btnSaveApiKey'),
        
        inputName: document.getElementById('inputName'),
        inputCategory: document.getElementById('inputCategory'),
        inputCost: document.getElementById('inputCost'),
        inputCurrency: document.getElementById('inputCurrency'),
        inputDate: document.getElementById('inputDate'),
        inputMemo: document.getElementById('inputMemo'),
        
        errorName: document.getElementById('errorName'),
        errorCategory: document.getElementById('errorCategory'),
        errorCost: document.getElementById('errorCost'),
        errorDate: document.getElementById('errorDate'),
        
        btnAdd: document.getElementById('btnAdd'),
        btnAddText: document.getElementById('btnAddText'),
        btnCancelEdit: document.getElementById('btnCancelEdit'),
        formTitleText: document.getElementById('formTitleText'),
        formTitleIcon: document.getElementById('formTitleIcon'),
        
        categoryTabs: document.getElementById('categoryTabs'),
        subList: document.getElementById('subList'),
        
        aiNoKey: document.getElementById('aiNoKey'),
        aiWithKey: document.getElementById('aiWithKey'),
        btnGoToSettings: document.getElementById('btnGoToSettings'),
        inputInterest: document.getElementById('inputInterest'),
        btnAnalyze: document.getElementById('btnAnalyze'),
        aiResult: document.getElementById('aiResult'),
        
        toastContainer: document.getElementById('toastContainer')
    };

    // --- Initialization ---
    function init() {
        loadData();
        renderTabs();
        renderSubscriptions();
        renderStats();
        updateAISection();
        
        // Set default date to today
        els.inputDate.valueAsDate = new Date();
    }

    // --- Data Logic ---
    function loadData() {
        const subData = localStorage.getItem(STORAGE_KEY_SUBS);
        subscriptions = subData ? JSON.parse(subData) : [];
        
        const keyData = localStorage.getItem(STORAGE_KEY_API);
        apiKey = keyData || '';
        
        if (apiKey) {
            els.inputApiKey.value = apiKey;
        }
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY_SUBS, JSON.stringify(subscriptions));
        renderSubscriptions();
        renderStats();
    }

    // --- Helper Functions ---
    function formatCurrency(amount, currency = 'KRW') {
        if (currency === 'USD') {
            return '$' + Number(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        return 'â‚©' + Number(amount).toLocaleString();
    }

    function calculateDaysRemaining(dateString) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const renewal = new Date(dateString);
        renewal.setHours(0, 0, 0, 0);
        
        const diffTime = renewal - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    function getDDayBadge(dateString) {
        const days = calculateDaysRemaining(dateString);
        
        // Past or Today (treat as imminent renewal or expired)
        if (days < 0) return ''; 
        
        if (days <= 3) {
            return `<span class="px-2 py-1 rounded-md bg-red-100 dark:bg-red-900/40 text-[10px] font-bold text-red-600 dark:text-red-300 uppercase tracking-wide flex items-center gap-1">
                        <span class="material-symbols-outlined text-[10px]">alarm</span> D-${days === 0 ? 'Day' : days}
                    </span>`;
        } else if (days <= 7) {
            return `<span class="px-2 py-1 rounded-md bg-orange-100 dark:bg-orange-900/40 text-[10px] font-bold text-orange-600 dark:text-orange-300 uppercase tracking-wide flex items-center gap-1">
                        D-${days}
                    </span>`;
        }
        return '';
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast px-4 py-3 bg-slate-800 text-white text-sm rounded-lg shadow-xl flex items-center gap-2';
        toast.innerHTML = message;
        
        els.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('hiding');
            toast.addEventListener('animationend', () => {
                toast.remove();
            });
        }, 2000);
    }

    // --- Rendering ---
    function renderStats() {
        const count = subscriptions.length;
        
        // Calculate Total Monthly in KRW (Convert USD to KRW)
        const totalMonthlyKRW = subscriptions.reduce((sum, sub) => {
            const cost = Number(sub.monthlyCost);
            const currency = sub.currency || 'KRW';
            if (currency === 'USD') {
                return sum + (cost * EXCHANGE_RATE);
            }
            return sum + cost;
        }, 0);
        
        const totalYearlyKRW = totalMonthlyKRW * 12;

        els.totalCount.textContent = `${count} ê°œ`;
        // Show approx symbol if USD conversion might be involved or just for general estimation
        els.totalMonthly.textContent = `â‰ˆ ${formatCurrency(totalMonthlyKRW, 'KRW')}`;
        els.totalYearly.textContent = `â‰ˆ ${formatCurrency(totalYearlyKRW, 'KRW')}`;
    }

    function renderTabs() {
        els.categoryTabs.innerHTML = CATEGORIES.map(cat => {
            const isActive = currentCategory === cat;
            const activeClass = "bg-primary text-white shadow-sm transform scale-105";
            const inactiveClass = "bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700";
            
            return `<button onclick="setCategory('${cat}')" 
                class="whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-all ${isActive ? activeClass : inactiveClass}">
                ${cat}
            </button>`;
        }).join('');
    }

    function renderSubscriptions() {
        // Filter
        let filtered = currentCategory === 'All' 
            ? subscriptions 
            : subscriptions.filter(sub => sub.category === currentCategory);
            
        // Sort by renewal date (earliest first)
        filtered.sort((a, b) => new Date(a.renewalDate) - new Date(b.renewalDate));

        if (filtered.length === 0) {
            els.subList.innerHTML = `
                <div class="text-center py-10 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                    <span class="material-symbols-outlined text-gray-300 text-4xl mb-2">sentiment_dissatisfied</span>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">
                        ${currentCategory === 'All' ? 'ì•„ì§ ë“±ë¡ëœ êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« êµ¬ë…ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!' : 'ì´ ì¹´í…Œê³ ë¦¬ì— êµ¬ë…ì´ ì—†ìŠµë‹ˆë‹¤.'}
                    </p>
                </div>
            `;
            return;
        }

        els.subList.innerHTML = filtered.map(sub => {
            const badgeHtml = getDDayBadge(sub.renewalDate);
            const colorClass = CATEGORY_COLORS[sub.category] || CATEGORY_COLORS['ê¸°íƒ€ AI'];
            const formattedCost = formatCurrency(sub.monthlyCost, sub.currency || 'KRW');
            
            return `
            <article class="bg-white dark:bg-gray-800 rounded-xl p-5 shadow-md border border-gray-100 dark:border-gray-700 relative overflow-hidden group hover:shadow-lg transition-shadow">
                <div class="absolute left-0 top-0 bottom-0 w-1 ${sub.category === 'GPT' ? 'bg-green-500' : 'bg-indigo-500'}"></div>
                
                <div class="flex justify-between items-start mb-3">
                    <div class="flex gap-2 items-center">
                        <span class="px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide ${colorClass}">${sub.category}</span>
                        ${badgeHtml}
                    </div>
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editSubscription('${sub.id}')" class="p-1 text-gray-400 hover:text-primary transition-colors">
                            <span class="material-symbols-outlined text-lg">edit</span>
                        </button>
                        <button onclick="deleteSubscription('${sub.id}')" class="p-1 text-gray-400 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined text-lg">delete</span>
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between items-end">
                    <div>
                        <h3 class="text-base font-bold text-slate-900 dark:text-white mb-1">${sub.serviceName}</h3>
                        <p class="text-xs text-gray-400 font-normal">ê°±ì‹ ì¼: ${sub.renewalDate.replace(/-/g, '.')}</p>
                        ${sub.memo ? `<p class="text-[11px] text-gray-400 mt-1 truncate max-w-[150px]">${sub.memo}</p>` : ''}
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-emerald-600 dark:text-emerald-400">${formattedCost}</p>
                        <p class="text-[10px] text-gray-400 text-right">/ month</p>
                    </div>
                </div>
            </article>
            `;
        }).join('');
    }

    function updateAISection() {
        if (apiKey) {
            els.aiNoKey.classList.add('hidden');
            els.aiWithKey.classList.remove('hidden');
        } else {
            els.aiNoKey.classList.remove('hidden');
            els.aiWithKey.classList.add('hidden');
        }
    }

    // --- Actions ---

    window.setCategory = (cat) => {
        currentCategory = cat;
        renderTabs();
        renderSubscriptions();
    };

    window.deleteSubscription = (id) => {
        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            subscriptions = subscriptions.filter(s => s.id !== id);
            saveData();
            showToast('âœ… êµ¬ë…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            
            // If we were editing this one, cancel edit
            if (editingId === id) resetForm();
        }
    };

    window.editSubscription = (id) => {
        const sub = subscriptions.find(s => s.id === id);
        if (!sub) return;

        editingId = id;
        
        // Fill form
        els.inputName.value = sub.serviceName;
        els.inputCategory.value = sub.category;
        els.inputCost.value = sub.monthlyCost;
        els.inputCurrency.value = sub.currency || 'KRW';
        els.inputDate.value = sub.renewalDate;
        els.inputMemo.value = sub.memo || '';

        // UI Change
        els.btnAddText.textContent = 'êµ¬ë… ìˆ˜ì •í•˜ê¸°';
        els.formTitleText.textContent = 'êµ¬ë… ìˆ˜ì •';
        els.formTitleIcon.textContent = 'edit';
        els.btnCancelEdit.classList.remove('hidden');
        
        // Scroll to form
        els.inputName.scrollIntoView({ behavior: 'smooth', block: 'center' });
    };

    function resetForm() {
        editingId = null;
        els.inputName.value = '';
        els.inputCategory.value = '';
        els.inputCost.value = '';
        els.inputCurrency.value = 'KRW';
        els.inputDate.valueAsDate = new Date();
        els.inputMemo.value = '';
        
        // Reset Validation UI
        [els.inputName, els.inputCategory, els.inputCost, els.inputDate].forEach(el => el.classList.remove('border-red-500'));
        [els.errorName, els.errorCategory, els.errorCost, els.errorDate].forEach(el => el.classList.add('hidden'));

        // UI Change
        els.btnAddText.textContent = 'êµ¬ë… ì¶”ê°€í•˜ê¸°';
        els.formTitleText.textContent = 'ìƒˆ êµ¬ë… ì¶”ê°€';
        els.formTitleIcon.textContent = 'add_circle';
        els.btnCancelEdit.classList.add('hidden');
    }

    // --- Event Listeners ---

    // Toggle API Key Visibility
    els.toggleApiKey.addEventListener('click', () => {
        const type = els.inputApiKey.type === 'password' ? 'text' : 'password';
        els.inputApiKey.type = type;
        els.toggleApiKey.innerHTML = `<span class="material-symbols-outlined text-lg">${type === 'password' ? 'visibility' : 'visibility_off'}</span>`;
    });

    // Save API Key
    els.btnSaveApiKey.addEventListener('click', () => {
        const val = els.inputApiKey.value.trim();
        apiKey = val;
        localStorage.setItem(STORAGE_KEY_API, apiKey);
        showToast('âœ… API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
        updateAISection();
        els.apiKeyAccordion.removeAttribute('open');
    });

    // Go to Settings Button
    els.btnGoToSettings.addEventListener('click', () => {
        els.apiKeyAccordion.setAttribute('open', '');
        els.apiKeyAccordion.scrollIntoView({ behavior: 'smooth' });
        els.inputApiKey.focus();
    });

    // Cancel Edit
    els.btnCancelEdit.addEventListener('click', resetForm);

    // Add/Update Subscription
    els.btnAdd.addEventListener('click', () => {
        // Validation
        let isValid = true;
        
        // Reset errors
        [els.errorName, els.errorCategory, els.errorCost, els.errorDate].forEach(e => e.classList.add('hidden'));
        [els.inputName, els.inputCategory, els.inputCost, els.inputDate].forEach(e => e.classList.remove('border-red-500'));

        if (!els.inputName.value.trim()) {
            els.inputName.classList.add('border-red-500');
            els.errorName.classList.remove('hidden');
            isValid = false;
        }
        if (!els.inputCategory.value) {
            els.inputCategory.classList.add('border-red-500');
            els.errorCategory.classList.remove('hidden');
            isValid = false;
        }
        if (!els.inputCost.value || Number(els.inputCost.value) <= 0) {
            els.inputCost.classList.add('border-red-500');
            els.errorCost.classList.remove('hidden');
            isValid = false;
        }
        if (!els.inputDate.value) {
            els.inputDate.classList.add('border-red-500');
            els.errorDate.classList.remove('hidden');
            isValid = false;
        }

        if (!isValid) return;

        const subData = {
            id: editingId || `sub_${Date.now()}`,
            serviceName: els.inputName.value.trim(),
            category: els.inputCategory.value,
            monthlyCost: Number(els.inputCost.value),
            currency: els.inputCurrency.value,
            renewalDate: els.inputDate.value,
            memo: els.inputMemo.value.trim(),
            createdAt: new Date().toISOString()
        };

        if (editingId) {
            // Update
            const index = subscriptions.findIndex(s => s.id === editingId);
            if (index !== -1) {
                subscriptions[index] = { ...subscriptions[index], ...subData };
                showToast('âœ… êµ¬ë…ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            }
        } else {
            // Add
            subscriptions.push(subData);
            showToast('âœ… êµ¬ë…ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
        }

        saveData();
        resetForm();
    });

    // AI Analysis
    els.btnAnalyze.addEventListener('click', async () => {
        if (!apiKey) {
            showToast('âš ï¸ API Keyê°€ í•„ìš”í•©ë‹ˆë‹¤');
            return;
        }

        const interest = els.inputInterest.value.trim();
        if (!interest) {
            showToast('âš ï¸ ê´€ì‹¬ ë¶„ì•¼ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            els.inputInterest.focus();
            return;
        }

        // Loading State
        const originalBtnText = els.btnAnalyze.innerHTML;
        els.btnAnalyze.innerHTML = `<div class="spinner mr-2"></div> ë¶„ì„ ì¤‘...`;
        els.btnAnalyze.disabled = true;
        els.aiResult.classList.add('hidden');

        try {
            const subListText = subscriptions.map(s => `- ${s.serviceName} (${s.category}, ${formatCurrency(s.monthlyCost, s.currency || 'KRW')})`).join('\n');
            const prompt = `
                í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ AI êµ¬ë… ëª©ë¡ì…ë‹ˆë‹¤:
                ${subListText}
                
                ì‚¬ìš©ìì˜ ê´€ì‹¬ ë¶„ì•¼ ë˜ëŠ” ì§ì—…: ${interest}
                
                ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ë‘ ê°€ì§€ ì„¹ì…˜ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”:
                1. "ğŸ’¡ ì¶”ì²œ AI ì„œë¹„ìŠ¤": ì‚¬ìš©ìì˜ ê´€ì‹¬ ë¶„ì•¼ì— ë§ì§€ë§Œ ì•„ì§ êµ¬ë…í•˜ì§€ ì•Šì€ ìœ ìš©í•œ AI ì„œë¹„ìŠ¤ 3ê°œ ì¶”ì²œ (ì´ìœ  í¬í•¨).
                2. "ğŸ§¹ ì •ë¦¬ ì¡°ì–¸": í˜„ì¬ êµ¬ë… ì¤‘ì¸ ì„œë¹„ìŠ¤ ì¤‘ ì¤‘ë³µë˜ê±°ë‚˜ ê´€ì‹¬ ë¶„ì•¼ì™€ ëœ ê´€ë ¨ë˜ì–´ ì •ë¦¬ê°€ í•„ìš”í•´ ë³´ì´ëŠ” ì„œë¹„ìŠ¤ì— ëŒ€í•œ ì¡°ì–¸.
                
                ë‹µë³€ì€ í•œêµ­ì–´ë¡œ ì¹œì ˆí•˜ê²Œ í•´ì£¼ì„¸ìš”.
            `;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error('API request failed');
            }

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;

            // Render Result
            els.aiResult.innerHTML = text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                .replace(/\n/g, '<br>'); // Line breaks
            
            els.aiResult.classList.remove('hidden');

        } catch (error) {
            console.error(error);
            showToast('âŒ API í˜¸ì¶œ ì‹¤íŒ¨. API Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
        } finally {
            els.btnAnalyze.innerHTML = originalBtnText;
            els.btnAnalyze.disabled = false;
        }
    });

    // Run Init
    init();

</script>
</body>
</html>